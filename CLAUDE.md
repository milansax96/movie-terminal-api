# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Build and Test Commands

```bash
go build -v ./...          # Build all packages
go test -v ./...           # Run all tests
go test -v ./internal/service/...          # Run a specific package's tests
go test -v -run TestDiscover ./internal/service/...  # Run a single test
golangci-lint run          # Lint
go mod tidy                # Install/clean dependencies
mockery                    # Regenerate mocks (uses .mockery.yaml config)
```

## Architecture

The app is a Gin HTTP API following a layered architecture:

```
handlers → services → repositories → PostgreSQL (GORM)
                    ↘ pkg/tmdb (TMDB API client, with caching decorator)
```

**Request flow:** Gin routes (`internal/handlers/routes.go`) dispatch to handler methods, which call service interfaces. Services coordinate between the TMDB client and repository layer. All layers communicate through interfaces defined in `internal/service/interfaces.go` and `internal/repository/`.

**Key design decisions:**
- **Domain/API separation:** `pkg/tmdb/` contains raw TMDB API types; `internal/models/` has clean domain models. `pkg/tmdb/mappers.go` converts between them.
- **Caching:** `pkg/tmdb/cache.go` is a decorator that wraps the real TMDB client. TTLs vary by endpoint (1h trending, 30m search, 24h details). Inject `CachedClient` instead of `Client` in `main.go`.
- **Mocks:** All interfaces have auto-generated mocks in `mocks/` subdirectories, generated by mockery from `.mockery.yaml`. Run `mockery` after changing any interface.
- **Auth:** JWT middleware (`internal/middleware/auth.go`) validates Bearer tokens and injects `user_id` into the Gin context. Access it with `c.Get("user_id")` in handlers.

## Testing Patterns

Tests use Testify and mockery-generated mocks. The `TestEnv` pattern in `internal/service/testenv_test.go` provides typed helpers for setting up mock expectations:

```go
env := newTestEnv(t)
env.TMDB.ReturnsTrending([]models.Movie{...})
env.Watchlist.ReturnsWatchlist(userID, nil)
result, err := env.MovieService().Discover(userID, "trending", 1)
```

Handler tests in `internal/handlers/testserver_test.go` spin up a test HTTP server with mocked services.

## Code Style

- **Linter:** `golangci-lint` with `nlreturn` enforced — always add a blank line before `return`.
- **Errors:** Wrap with context: `fmt.Errorf("context: %w", err)`. Service-level sentinel errors are in `internal/service/errors.go`.
- **Naming:** camelCase for unexported, PascalCase for exported.
- Run `gofmt` before committing.
